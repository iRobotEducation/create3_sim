<?xml version="1.0"?>
<robot xmlns:xacro="http://ros.org/wiki/xacro">
<xacro:macro name="wheel_drop" params="name parent_link *origin" >
  <xacro:include filename="$(find irobot_create_description)/urdf/common_properties.urdf.xacro"/>

  <xacro:property name="detection_threshold_cm" value="3"/>
  <xacro:property name="spring_stiffness_nm"    value="450"/>

  <!-- Sensor settings -->
  <xacro:property name="update_rate" value="62" />

  <joint name="wheel_${name}_axle_joint" type="prismatic">
    <parent link="${parent_link}"/>
    <child link="wheel_${name}_axle_link"/>
    <xacro:insert_block name="origin"/>
    <axis xyz="0 1 0"/>
    <limit lower="0" upper="${detection_threshold_cm*cm2m}" effort="0" velocity="0"/>
    <!-- Damping is big enough to don't make the body oscillate too much when it's lifted up -->
    <dynamics damping="50" friction="0.1"/>
  </joint>

  <!-- Gazebo parameters to simulate a spring -->
  <gazebo reference="wheel_${name}_axle_joint">
    <provideFeedback>false</provideFeedback>
    <implicitSpringDamper>true</implicitSpringDamper>
    <!-- This value should be high enough so that the wheeldrop can
          retract with the robot's weight (mass * gravity) -->
    <springStiffness>${spring_stiffness_nm}</springStiffness>
    <springReference>${detection_threshold_cm*cm2m}</springReference>
  </gazebo>

  <link name="wheel_${name}_axle_link">
    <xacro:inertial_cuboid mass="0.05" x="0.15" y="0.15" z="0.15"/>
  </link>

  <gazebo>
    <plugin name="wheel_drop_${name}" filename="libgazebo_ros_create_wheel_drop.so">
      <ros>
        <namespace>wheel_drop</namespace>
        <argument>~/out:=${name}_wheel/event</argument>
      </ros>
      <updateRate>${update_rate}</updateRate>
      <detectionThreshold>${detection_threshold_cm*cm2m}</detectionThreshold>
      <jointName>wheel_${name}_axle_joint</jointName>
      <frameId>wheel_${name}_axle_link</frameId>
    </plugin>
  </gazebo>

</xacro:macro>
</robot>
